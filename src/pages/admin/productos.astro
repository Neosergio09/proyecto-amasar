---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { getSupabaseServer, getOptimizedImage } from "../../lib/supabase";
import { Image } from "astro:assets";
import type { Product } from "../../types/database";

// Auth & Data Fetching (SSR)
const supabase = await getSupabaseServer(Astro.cookies);
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/admin/login");
}

let productos = [];
let errorMsg = null;

try {
  // Use the authenticated client to fetch data
  const { data, error } = await supabase
    .from("productos")
    .select("*")
    // 'created_at' might not exist in the DB yet, so we sort by 'nombre' or 'id' to be safe
    .order("nombre", { ascending: true });

  if (error) {
    throw error;
  }

  productos = data || [];
} catch (err) {
  console.error("Error fetching products:", err);
  // We can choose to show an empty table or set an error flag
  errorMsg =
    "No se pudieron cargar los productos. Por favor intenta m√°s tarde.";
}
---

<AdminLayout>
  <div class="mb-8 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-serif text-secondary mb-2">Inventario</h1>
      <p class="text-slate-500 text-sm">
        Gestiona el stock y precios de tus productos en tiempo real.
      </p>
    </div>
    <button
      class="bg-primary text-white font-bold px-6 py-3 rounded-xl shadow-lg shadow-primary/20 hover:bg-orange-600 transition-colors text-sm"
    >
      + Nuevo Producto
    </button>
  </div>

  <div
    class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden"
  >
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead class="bg-gray-50/50 border-b border-gray-100">
          <tr>
            <th
              class="px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500"
              >Producto</th
            >
            <th
              class="px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500"
              >Categor√≠a</th
            >
            <th
              class="px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500 w-32"
              >Precio</th
            >
            <th
              class="px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500 w-32"
              >Stock</th
            >
            <th
              class="px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500 text-right"
              >Estado</th
            >
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {
            productos?.map((producto: Product) => (
              <tr class="hover:bg-slate-50/50 transition-colors group">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl overflow-hidden bg-gray-100 shrink-0 border border-gray-100">
                      <img
                        src={getOptimizedImage(producto.imagen_url, 100)}
                        alt={producto.nombre}
                        class="w-full h-full object-cover"
                        loading="lazy"
                        width="48"
                        height="48"
                      />
                    </div>
                    <div>
                      <p class="font-bold text-secondary text-sm">
                        {producto.nombre}
                      </p>
                      <p class="text-xs text-slate-400 truncate max-w-[200px]">
                        {producto.descripcion?.substring(0, 30)}...
                      </p>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 capitalize">
                    {producto.categoria}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs">
                      $
                    </span>
                    <input
                      type="number"
                      value={producto.precio}
                      data-id={producto.id}
                      data-field="precio"
                      class="editable-input w-full pl-6 pr-3 py-2 text-sm font-medium text-slate-700 bg-transparent border border-transparent hover:border-gray-200 focus:bg-white focus:border-primary rounded-lg transition-all outline-none"
                      placeholder="0.00"
                    />
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-2">
                    <span
                      class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-md min-w-[30px] text-center stock-display"
                      data-id={producto.id}
                    >
                      {producto.stock_cantidad}
                    </span>
                    <input
                      type="number"
                      data-id={producto.id}
                      data-field="stock_cantidad"
                      class="editable-input w-20 px-2 py-1 text-xs font-medium text-slate-700 bg-white border border-gray-200 focus:border-primary rounded-lg transition-all outline-none"
                      placeholder="+/-"
                    />
                  </div>
                </td>
                <td class="px-6 py-4 text-right">
                  <span
                    class={`inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-bold ${producto.stock_cantidad > 0 ? "bg-green-50 text-green-700" : "bg-red-50 text-red-700"}`}
                  >
                    <span
                      class={`w-1.5 h-1.5 rounded-full ${producto.stock_cantidad > 0 ? "bg-green-500" : "bg-red-500"}`}
                    />
                    {producto.stock_cantidad > 0 ? "En Stock" : "Agotado"}
                  </span>
                </td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Notifications Toast -->
  <div
    id="toast"
    class="fixed bottom-6 right-6 transform translate-y-24 opacity-0 transition-all duration-300 z-50"
  >
    <div
      class="bg-secondary text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-5 h-5 text-green-400"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
          clip-rule="evenodd"></path>
      </svg>
      <span class="font-medium text-sm">Cambios guardados correctamente</span>
    </div>
  </div>
</AdminLayout>

<script>
  import { supabase } from "../../lib/supabase";

  const inputs = document.querySelectorAll(".editable-input");
  const toast = document.getElementById("toast");
  let timeoutId: number;

  function showToast() {
    if (!toast) return;
    toast.classList.remove("translate-y-24", "opacity-0");

    if (timeoutId) clearTimeout(timeoutId);

    timeoutId = setTimeout(() => {
      toast.classList.add("translate-y-24", "opacity-0");
    }, 3000);
  }

  async function handleUpdate(e: Event) {
    const input = e.target as HTMLInputElement;
    const id = input.dataset.id;
    const field = input.dataset.field;
    let value = input.value;
    const originalValue = input.defaultValue;

    if (!id || !field || value === "") return;

    // 0. Verify Session
    const {
      data: { session },
      error: sessionError,
    } = await supabase.auth.getSession();
    if (sessionError || !session) {
      console.error("‚ùå Auth Error:", sessionError);
      alert("Tu sesi√≥n ha expirado.");
      input.value = originalValue;
      return;
    }

    input.classList.add("opacity-50", "cursor-wait");

    try {
      let newValue = value;
      let successMessage = "Cambios guardados correctamente";

      // 1. LOGIC DIVISION: Stock (Additive) vs Others (Absolute)
      if (field === "stock_cantidad") {
        const delta = parseInt(value, 10);
        if (isNaN(delta))
          throw new Error("Por favor ingresa un n√∫mero v√°lido.");

        // A. Fetch current 'fresh' stock
        const { data: currentData, error: fetchError } = await supabase
          .from("productos")
          .select("stock_cantidad")
          .eq("id", id)
          .single();

        if (fetchError)
          throw new Error(
            "Error obteniendo stock actual: " + fetchError.message,
          );

        // B. Calculate new total
        const currentStock = currentData.stock_cantidad || 0;
        const newTotal = currentStock + delta;
        newValue = newTotal.toString();

        console.log(
          `üßÆ Stock Logic: ${currentStock} + (${delta}) = ${newTotal}`,
        );

        successMessage = `Stock actualizado: ${currentStock} -> ${newTotal} (${delta > 0 ? "+" : ""}${delta})`;
      }

      // 2. Perform Update
      // For stock, we update with the calculated total. For others, just the input value.
      const updateValue = field === "stock_cantidad" ? newValue : value;

      const { data, error } = await supabase
        .from("productos")
        .update({ [field]: updateValue })
        .eq("id", id)
        .select();

      input.classList.remove("opacity-50", "cursor-wait");

      if (error) throw new Error(error.message);
      if (!data || data.length === 0)
        throw new Error("No se pudo actualizar el registro.");

      // 3. Success Feedback & UI Update
      console.log("‚úÖ Update success:", data);

      // Custom toast text
      const toastText = document.querySelector("#toast span");
      if (toastText) toastText.textContent = successMessage;
      showToast();

      // Clear input if it was stock (ready for next addition)
      if (field === "stock_cantidad") {
        input.value = "";
        // Update the display badge
        const stockDisplay =
          input.parentElement?.querySelector(".stock-display");
        if (stockDisplay) stockDisplay.textContent = newValue;
      } else {
        input.defaultValue = value;
      }

      // 4. Update Status Badge (En Stock / Agotado) if likely changed
      if (field === "stock_cantidad") {
        const newStock = parseInt(newValue);
        const row = input.closest("tr");
        const badgeContainer = row?.querySelector("td:last-child span"); // Approximate selector for "Estado" column contents

        // Simple heuristic: reload or smart DOM update.
        // Ideally we would toggle classes here, but let's trust the user refreshes for major status changes
        // or we could implement a quick class toggle:
        if (badgeContainer) {
          const isStock = newStock > 0;
          // Reset classes
          badgeContainer.className = `inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-bold ${isStock ? "bg-green-50 text-green-700" : "bg-red-50 text-red-700"}`;
          badgeContainer.innerHTML = `<span class="w-1.5 h-1.5 rounded-full ${isStock ? "bg-green-500" : "bg-red-500"}"></span>${isStock ? "En Stock" : "Agotado"}`;
        }
      }
    } catch (err: any) {
      console.error("üî• Error:", err);
      alert(`Error: ${err.message}`);
      if (field !== "stock_cantidad") input.value = originalValue;
      else input.value = ""; // Clear stock input on error to avoid confusion? Or keep it?
      input.classList.remove("opacity-50", "cursor-wait");
    }
  }

  inputs.forEach((input) => {
    // Save on blur or Enter key
    input.addEventListener("change", handleUpdate);
    input.addEventListener("keydown", (e: KeyboardEvent) => {
      if (e.key === "Enter") (e.target as HTMLInputElement).blur();
    });
  });
</script>
