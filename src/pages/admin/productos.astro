---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { getSupabaseServer, getOptimizedImage } from "../../lib/supabase";
import { Image } from "astro:assets";
import type { Product } from "../../types/database";

// Auth & Data Fetching (SSR)
const supabase = await getSupabaseServer(Astro.cookies);
// Auth handled by middleware
// const {
//   data: { session },
// } = await supabase.auth.getSession();

// if (!session) {
//   return Astro.redirect("/admin/login");
// }

let productos = [];
let errorMsg = null;

try {
  // Use the authenticated client to fetch data
  const { data, error } = await supabase
    .from("productos")
    .select("*")
    // 'created_at' might not exist in the DB yet, so we sort by 'nombre' or 'id' to be safe
    .order("nombre", { ascending: true });

  if (error) {
    throw error;
  }

  productos = data || [];
} catch (err) {
  console.error("Error fetching products:", err);
  // We can choose to show an empty table or set an error flag
  errorMsg =
    "No se pudieron cargar los productos. Por favor intenta m√°s tarde.";
}
---

<AdminLayout title="Gesti√≥n de Productos">
  <div
    class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
  >
    <div>
      <h1 class="text-3xl font-serif text-secondary mb-2">Inventario</h1>
      <p class="text-slate-500 text-sm">
        Gestiona el stock y precios de tus productos en tiempo real.
      </p>
    </div>
    <a
      href="/admin/productos/nuevo"
      class="w-full md:w-auto bg-primary text-white font-bold px-6 py-3 rounded-xl shadow-lg shadow-primary/20 hover:bg-orange-600 transition-colors text-sm flex items-center justify-center gap-2"
    >
      <span>+ Nuevo Producto</span>
    </a>
  </div>

  <div
    class="bg-white rounded-2xl md:rounded-3xl shadow-sm border border-gray-100 overflow-hidden"
  >
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead class="bg-gray-50/50 border-b border-gray-100">
          <tr>
            <th
              class="px-3 md:px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500"
              >Producto</th
            >
            <th
              class="px-3 md:px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500"
              >Categor√≠a</th
            >
            <th
              class="px-3 md:px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500 w-32"
              >Precio</th
            >
            <th
              class="px-3 md:px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500 w-32"
              >Stock</th
            >
            <th
              class="px-3 md:px-6 py-4 text-[10px] uppercase tracking-widest font-black text-slate-500 text-right"
              >Estado</th
            >
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {
            productos?.map((producto: Product) => (
              <tr class="hover:bg-slate-50/50 transition-colors group">
                <td class="px-3 md:px-6 py-4">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl overflow-hidden bg-gray-100 shrink-0 border border-gray-100">
                      <img
                        src={getOptimizedImage(producto.imagen_url, 100)}
                        alt={producto.nombre}
                        class="w-full h-full object-cover"
                        loading="lazy"
                        width="48"
                        height="48"
                      />
                    </div>
                    <div>
                      <p class="font-bold text-secondary text-sm">
                        {producto.nombre}
                      </p>
                      <p class="text-xs text-slate-400 truncate max-w-[200px]">
                        {producto.descripcion?.substring(0, 30)}...
                      </p>
                    </div>
                  </div>
                </td>
                <td class="px-3 md:px-6 py-4">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 capitalize">
                    {producto.categoria}
                  </span>
                </td>
                <td class="px-3 md:px-6 py-4">
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs">
                      $
                    </span>
                    <input
                      type="number"
                      value={producto.precio}
                      data-id={producto.id}
                      data-field="precio"
                      class="editable-input w-full pl-6 pr-3 py-2 text-sm font-medium text-slate-700 bg-transparent border border-transparent hover:border-gray-200 focus:bg-white focus:border-primary rounded-lg transition-all outline-none"
                      placeholder="0.00"
                    />
                  </div>
                </td>
                <td class="px-3 md:px-6 py-4">
                  <div class="flex items-center gap-2">
                    <span
                      class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-md min-w-[30px] text-center stock-display"
                      data-id={producto.id}
                    >
                      {producto.stock_cantidad}
                    </span>
                    <input
                      type="number"
                      data-id={producto.id}
                      data-field="stock_cantidad"
                      class="editable-input w-20 px-2 py-1 text-xs font-medium text-slate-700 bg-white border border-gray-200 focus:border-primary rounded-lg transition-all outline-none"
                      placeholder="+/-"
                    />
                  </div>
                </td>
                <td class="px-3 md:px-6 py-4 text-right">
                  <span
                    class={`inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-bold ${producto.stock_cantidad > 0 ? "bg-green-50 text-green-700" : "bg-red-50 text-red-700"}`}
                  >
                    <span
                      class={`w-1.5 h-1.5 rounded-full ${producto.stock_cantidad > 0 ? "bg-green-500" : "bg-red-500"}`}
                    />
                    {producto.stock_cantidad > 0 ? "En Stock" : "Agotado"}
                  </span>
                </td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Notifications Toast -->
  <div
    id="toast"
    class="fixed bottom-6 right-6 transform translate-y-24 opacity-0 transition-all duration-300 z-50"
  >
    <div
      class="bg-secondary text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-5 h-5 text-green-400"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
          clip-rule="evenodd"></path>
      </svg>
      <span class="font-medium text-sm">Cambios guardados correctamente</span>
    </div>
  </div>
</AdminLayout>

<script>
  import { supabase } from "../../lib/supabase";

  const inputs = document.querySelectorAll(".editable-input");
  const toast = document.getElementById("toast");
  let timeoutId: any;

  function showToast() {
    if (!toast) return;
    toast.classList.remove("translate-y-24", "opacity-0");

    if (timeoutId) clearTimeout(timeoutId);

    timeoutId = setTimeout(() => {
      toast.classList.add("translate-y-24", "opacity-0");
    }, 3000);
  }

  async function handleUpdate(e: Event) {
    const input = e.target as HTMLInputElement;
    const id = input.dataset.id;
    const field = input.dataset.field;
    let value = input.value;
    const originalValue = input.defaultValue;

    // ‚õî Validaci√≥n de Identidad del Recurso
    if (!id || !field) {
      console.error("‚ùå Security Error: Missing Resource ID or Field Target.");
      return;
    }

    // Evitar vac√≠os
    if (value === "") return;

    // üîí 1. Verificaci√≥n de Sesi√≥n Activa (Bank-Grade Check)
    const {
      data: { session },
      error: sessionError,
    } = await supabase.auth.getSession();

    if (sessionError || !session) {
      console.error(
        "‚õî Security Alert: Invalid or Expired Session.",
        sessionError,
      );
      alert(
        "Su sesi√≥n ha expirado por seguridad. Por favor inicie sesi√≥n nuevamente.",
      );
      // Forzar recarga para redirigir al login v√≠a middleware
      window.location.reload();
      return;
    }

    // UI Feedback: Cargando...
    input.classList.add("opacity-50", "cursor-wait");
    const parentRow = input.closest("tr");
    if (parentRow) parentRow.classList.add("bg-blue-50/50");

    try {
      let newValue = value;
      let successMessage = "Cambios guardados correctamente";

      // üîÑ 2. L√≥gica de Stock (Aditiva vs Absoluta)
      if (field === "stock_cantidad") {
        const delta = parseInt(value, 10);

        if (isNaN(delta)) {
          throw new Error("Formato inv√°lido: Ingrese un n√∫mero.");
        }

        // A. Obtener stock 'fresco' (Concurrency Safe-ish)
        const { data: currentData, error: fetchError } = await supabase
          .from("productos")
          .select("stock_cantidad")
          .eq("id", id)
          .single();

        if (fetchError)
          throw new Error(`Error de Sincronizaci√≥n: ${fetchError.message}`);

        // B. Calcular nuevo total
        const currentStock = currentData?.stock_cantidad ?? 0;
        const newTotal = currentStock + delta;

        // Validaci√≥n de Negativos
        if (newTotal < 0) {
          throw new Error(
            `Operaci√≥n rechazada: El stock no puede ser negativo (Actual: ${currentStock}).`,
          );
        }

        newValue = newTotal.toString();
        successMessage = `Stock actualizado: ${currentStock} ‚ûú ${newTotal}`;
      }

      // üíæ 3. Persistencia Segura
      const updatePayload = {
        [field]: field === "stock_cantidad" ? newValue : value,
      };

      const { data, error } = await supabase
        .from("productos")
        .update(updatePayload)
        .eq("id", id)
        .select()
        .single();

      if (error) {
        // Logging Detallado para Auditor√≠a
        console.error(
          `‚ùå Database Update Error [ID: ${id}]:`,
          error.message,
          error.details,
        );
        throw new Error(error.message);
      }

      // ‚úÖ 4. Actualizaci√≥n UI
      console.log("‚úÖ Audit: Update success", data);

      const toastText = document.querySelector("#toast span");
      if (toastText) toastText.textContent = successMessage;
      showToast();

      if (field === "stock_cantidad") {
        input.value = ""; // Reset input relativo
        // Actualizar visualizador est√°tico
        const stockDisplay =
          input.parentElement?.querySelector(".stock-display");
        if (stockDisplay) {
          stockDisplay.textContent = newValue;
          // Animaci√≥n
          stockDisplay.classList.add("bg-green-100", "text-green-800");
          setTimeout(
            () =>
              stockDisplay.classList.remove("bg-green-100", "text-green-800"),
            1000,
          );
        }

        // Actualizar Badge de Estado
        const newStock = parseInt(newValue);
        const badgeCell = parentRow?.querySelector("td:last-child span");
        if (badgeCell) {
          const isStock = newStock > 0;
          badgeCell.className = `inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-bold ${isStock ? "bg-green-50 text-green-700" : "bg-red-50 text-red-700"}`;
          badgeCell.innerHTML = `<span class="w-1.5 h-1.5 rounded-full ${isStock ? "bg-green-500" : "bg-red-500"}"></span>${isStock ? "En Stock" : "Agotado"}`;
        }
      } else {
        input.defaultValue = value; // Update 'clean' state
      }
    } catch (err: any) {
      console.error("üî• System Error:", err);
      alert(`No se pudo guardar: ${err.message}`);

      // Rollback visual
      if (field !== "stock_cantidad") input.value = originalValue;
      else input.value = "";
    } finally {
      input.classList.remove("opacity-50", "cursor-wait");
      if (parentRow) parentRow.classList.remove("bg-blue-50/50");
    }
  }

  inputs.forEach((input) => {
    input.addEventListener("change", handleUpdate);
    input.addEventListener("keydown", (e: Event) => {
      if ((e as KeyboardEvent).key === "Enter")
        (e.target as HTMLInputElement).blur();
    });
  });

  // Check for success param
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("success") === "true") {
    const toastText = document.querySelector("#toast span");
    if (toastText) toastText.textContent = "¬°Producto creado con √©xito!";
    showToast();
    window.history.replaceState({}, document.title, window.location.pathname);
  }
</script>
