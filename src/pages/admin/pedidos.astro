---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { supabase } from "../../lib/supabase";

// 1. SSR ACTIVO: Crucial para ver cambios en tiempo real
export const prerender = false;

const title = "Gesti√≥n de Pedidos y Rastreo | Amasar";

// Traemos los pedidos frescos de la base de datos
const { data: pedidos, error } = await supabase
  .from("pedidos")
  .select("*")
  .order("creado_en", { ascending: false });

if (error) console.error("Error cargando pedidos:", error.message);

const estadosLogistica = [
  "Preparaci√≥n",
  "En horno",
  "Empacado",
  "En camino",
  "Entregado",
];
---

<AdminLayout title={title}>
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-12">
    <div class="lg:col-span-1">
      <div
        class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 sticky top-32"
      >
        <h2 class="text-lg font-bold text-secondary mb-6">Nuevo Despacho</h2>
        <form id="orderForm" class="space-y-4">
          <div>
            <label
              class="block text-[10px] uppercase font-black text-slate-400 mb-2 tracking-widest"
              >Panader√≠a / Cliente</label
            >
            <input
              type="text"
              name="cliente"
              required
              class="w-full p-4 rounded-xl bg-slate-50 border-none outline-none focus:ring-2 focus:ring-primary transition-all"
              placeholder="Ej: Masa Madre Bog"
            />
          </div>

          <div>
            <label
              class="block text-[10px] uppercase font-black text-slate-400 mb-2 tracking-widest"
              >Estado de Inicio</label
            >
            <select
              name="estado"
              class="w-full p-4 rounded-xl bg-slate-50 border-none outline-none focus:ring-2 focus:ring-primary"
            >
              {
                estadosLogistica.map((est) => (
                  <option value={est}>{est}</option>
                ))
              }
            </select>
          </div>

          <button
            type="submit"
            class="w-full py-5 bg-secondary text-white rounded-2xl font-black uppercase tracking-[0.2em] text-[10px] hover:bg-primary transition-all shadow-lg active:scale-95"
          >
            Generar Orden
          </button>
        </form>
      </div>
    </div>

    <div class="lg:col-span-3">
      <div
        class="bg-white rounded-[3rem] shadow-sm border border-slate-100 overflow-hidden"
      >
        <table class="w-full text-left border-collapse">
          <thead>
            <tr
              class="bg-slate-50 text-[10px] uppercase tracking-widest text-slate-400"
            >
              <th class="px-8 py-5">C√≥digo (Tag)</th>
              <th class="px-8 py-5">Panader√≠a</th>
              <th class="px-8 py-5">Estado</th>
              <th class="px-8 py-5 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-50">
            {
              pedidos?.map((ped) => (
                <tr class="hover:bg-slate-50/50 transition-colors">
                  <td class="px-8 py-6 font-black text-primary text-xs tracking-tighter">
                    {ped.tag_rastreo}
                  </td>
                  <td class="px-8 py-6">
                    <p class="font-bold text-secondary text-sm">
                      {ped.cliente_nombre}
                    </p>
                    <p class="text-[9px] text-slate-400 uppercase tracking-widest">
                      Bogot√°, Colombia
                    </p>
                  </td>
                  <td class="px-8 py-6">
                    <div class="flex items-center gap-2">
                      <select class="status-select bg-slate-100 text-[10px] font-black uppercase px-4 py-2 rounded-xl border-none outline-none focus:ring-2 focus:ring-primary transition-all cursor-pointer">
                        {estadosLogistica.map((est) => (
                          <option value={est} selected={est === ped.estado}>
                            {est}
                          </option>
                        ))}
                      </select>
                      <button
                        class="update-btn p-2 bg-secondary text-white rounded-xl hover:bg-primary transition-all active:scale-90 text-[10px] font-bold uppercase shadow-md shadow-secondary/10"
                        data-id={ped.id}
                      >
                        Guardar
                      </button>
                    </div>
                  </td>
                  <td class="px-8 py-6 text-center">
                    <button
                      class="delete-order text-red-200 hover:text-red-500 transition-colors p-2"
                      data-id={ped.id}
                    >
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { supabase } from "../../lib/supabase";

  const initOrders = () => {
    console.log("üîç [TRAZA 1]: Script de Pedidos inicializado correctamente.");

    const form = document.getElementById("orderForm") as HTMLFormElement;

    // 1. L√≥gica para Crear Pedido
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      const year = 2026;
      const randomId = Math.floor(1000 + Math.random() * 9000);
      const generatedTag = `AM-${year}-${randomId}`;

      const { error } = await supabase.from("pedidos").insert([
        {
          tag_rastreo: generatedTag,
          cliente_nombre: formData.get("cliente"),
          estado: formData.get("estado"),
          creado_en: new Date().toISOString(),
        },
      ]);

      if (error) alert("Error al crear orden: " + error.message);
      else window.location.reload();
    });

    // 2. L√ìGICA DE ACTUALIZACI√ìN CON TRAZABILIDAD
    const updateButtons = document.querySelectorAll(".update-btn");
    console.log(
      `üîç [TRAZA 2]: Se encontraron ${updateButtons.length} botones de actualizaci√≥n.`,
    );

    updateButtons.forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const id = button.getAttribute("data-id");
        console.log("üîç [TRAZA 3]: Bot√≥n clickeado. ID del pedido:", id);

        // Localizamos el selector de la misma fila
        const row = button.closest("tr");
        const select = row?.querySelector(
          ".status-select",
        ) as HTMLSelectElement;
        const nuevoEstado = select.value;
        console.log("üîç [TRAZA 4]: Nuevo estado capturado:", nuevoEstado);

        if (!id || !nuevoEstado) {
          console.error(
            "‚ùå [ERROR]: No se pudo obtener el ID o el Estado del DOM.",
          );
          return;
        }

        // Feedback visual de inicio
        button.innerText = "...";
        button.disabled = true;

        console.log("üîç [TRAZA 5]: Enviando actualizaci√≥n a Supabase...");

        const { data, error, status } = await supabase
          .from("pedidos")
          .update({ estado: nuevoEstado })
          .eq("id", id)
          .select(); // El .select() ayuda a confirmar que el cambio ocurri√≥

        if (error) {
          console.error("‚ùå [TRAZA 6]: Error de Supabase:", error.message);
          alert("Error al actualizar: " + error.message);
          button.innerText = "Guardar";
          button.disabled = false;
        } else {
          console.log(
            "‚úÖ [TRAZA 7]: ¬°√âxito! Respuesta de la DB:",
            data,
            "Status:",
            status,
          );

          // Animaci√≥n de √©xito
          button.innerText = "¬°OK!";
          button.classList.replace("bg-secondary", "bg-green-500");

          setTimeout(() => {
            button.innerText = "Guardar";
            button.classList.replace("bg-green-500", "bg-secondary");
            button.disabled = false;
          }, 1500);
        }
      });
    });

    // 3. Borrar Pedidos
    document.querySelectorAll(".delete-order").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-id");
        if (confirm("¬øSeguro que quieres borrar este pedido?")) {
          const { error } = await supabase
            .from("pedidos")
            .delete()
            .eq("id", id);
          if (error) alert("Error al borrar");
          else window.location.reload();
        }
      });
    });
  };

  // Re-inicializar en cada navegaci√≥n de Astro
  document.addEventListener("astro:page-load", initOrders);
</script>
