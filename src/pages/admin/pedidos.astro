---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { supabase } from "../../lib/supabase";

// 1. SSR ACTIVO: Crucial para ver cambios en tiempo real
export const prerender = false;

const title = "Gesti√≥n de Pedidos y Rastreo | Amasar";

// Traemos los pedidos frescos de la base de datos con el cliente asociado
const { data: pedidos, error } = await supabase
  .from("pedidos")
  .select("*, clientes(nombre_comercial)")
  .order("created_at", { ascending: false });

if (error) console.error("Error cargando pedidos:", error.message);

const estadosLogistica = [
  "Preparaci√≥n",
  "En horno",
  "Empacado",
  "En camino",
  "Entregado",
];
---

<AdminLayout title={title}>
  <div class="w-full">
    <div class="w-full">
      <div
        class="bg-white rounded-2xl md:rounded-[3rem] shadow-sm border border-slate-100 overflow-hidden"
      >
        <table class="w-full text-left border-collapse">
          <thead>
            <tr
              class="bg-slate-50 text-[10px] uppercase tracking-widest text-slate-400"
            >
              <th class="px-3 md:px-8 py-5">C√≥digo (Tag)</th>
              <th class="px-3 md:px-8 py-5">Panader√≠a</th>
              <th class="px-3 md:px-8 py-5">Estado</th>
              <th class="px-3 md:px-8 py-5 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-50">
            {
              pedidos?.map((ped) => (
                <tr class="hover:bg-slate-50/50 transition-colors">
                  <td class="px-3 md:px-8 py-6 font-black text-primary text-xs tracking-tighter">
                    {ped.tag_rastreo}
                  </td>
                  <td class="px-3 md:px-8 py-6">
                    <p class="font-bold text-secondary text-sm">
                      {ped.clientes?.nombre_comercial || 'Cliente no encontrado'}
                    </p>
                    <p class="text-[9px] text-slate-400 uppercase tracking-widest">
                      Bogot√°, Colombia
                    </p>
                  </td>
                  <td class="px-3 md:px-8 py-6">
                    <div class="flex items-center gap-2">
                      <select class="status-select bg-slate-100 text-[10px] font-black uppercase px-4 py-2 rounded-xl border-none outline-none focus:ring-2 focus:ring-primary transition-all cursor-pointer">
                        {estadosLogistica.map((est) => (
                          <option value={est} selected={est === ped.estado}>
                            {est}
                          </option>
                        ))}
                      </select>
                      <button
                        class="update-btn p-2 bg-secondary text-white rounded-xl hover:bg-primary transition-all active:scale-90 text-[10px] font-bold uppercase shadow-md shadow-secondary/10"
                        data-id={ped.id}
                      >
                        Guardar
                      </button>
                    </div>
                  </td>
                  <td class="px-3 md:px-8 py-6 text-center flex items-center justify-center gap-2">
                     <!-- Edit Button -->
                    <button
                      class="edit-order text-blue-500 hover:bg-blue-50 p-2 rounded-full transition-colors"
                      data-id={ped.id}
                      data-detalles={JSON.stringify(ped.detalles || [])}
                      data-total={ped.total || 0}
                      title="Editar Cantidades"
                    >
                      ‚úèÔ∏è
                    </button>
                    <!-- Cancel Button -->
                     {ped.estado !== 'Cancelado' && (
                        <button
                        class="cancel-order text-orange-500 hover:bg-orange-50 p-2 rounded-full transition-colors"
                        data-id={ped.id}
                        data-detalles={JSON.stringify(ped.detalles || [])}
                        title="Cancelar Pedido (Restaurar Stock)"
                        >
                        üö´
                        </button>
                     )}
                     <!-- Delete Button -->
                    <button
                      class="delete-order text-red-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors"
                      data-id={ped.id}
                      title="Eliminar (Solo Registro)"
                    >
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <dialog id="editModal" class="bg-white rounded-2xl md:rounded-[2.5rem] shadow-2xl p-0 w-[95%] md:w-full max-w-lg backdrop:bg-gray-900/20 backdrop:backdrop-blur-sm">
      <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center">
          <h3 class="text-xl font-black text-gray-900">Editar Pedido</h3>
          <button onclick="document.getElementById('editModal').close()" class="bg-gray-100 p-2 rounded-full text-gray-500 hover:bg-gray-200">
              ‚úñ
          </button>
      </div>
      <div class="p-8 space-y-4" id="modalContent">
          <!-- Inject Items Here -->
      </div>
      <div class="p-6 md:p-8 border-t border-gray-100 bg-gray-50 rounded-b-2xl md:rounded-b-[2.5rem] flex justify-end gap-3">
          <button onclick="document.getElementById('editModal').close()" class="bg-white border border-gray-200 text-gray-600 font-bold px-6 h-12 rounded-[2.5rem] hover:bg-gray-50">Cancelar</button>
          <button id="saveEditBtn" class="bg-blue-600 text-white font-bold px-8 h-12 rounded-[2.5rem] hover:bg-blue-500 shadow-lg shadow-blue-200">Guardar Cambios</button>
      </div>
  </dialog>

</AdminLayout>

<script>
  import { supabase } from "../../lib/supabase";

  const initOrders = () => {
    console.log("üîç [TRAZA 1]: Script de Pedidos inicializado.");

    // --- 1. Update Status (Existing) ---
    const updateButtons = document.querySelectorAll(".update-btn");
    updateButtons.forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const id = button.getAttribute("data-id");
        const row = button.closest("tr");
        const select = row?.querySelector(".status-select") as HTMLSelectElement;
        const nuevoEstado = select.value;

        if (!id || !nuevoEstado) return;

        button.innerText = "...";
        button.disabled = true;

        const { error } = await supabase
          .from("pedidos")
          .update({ estado: nuevoEstado })
          .eq("id", id);

        if (error) {
          alert("Error: " + error.message);
          button.innerText = "Guardar";
          button.disabled = false;
        } else {
          button.innerText = "¬°OK!";
          button.classList.replace("bg-secondary", "bg-green-500");
          setTimeout(() => {
            button.innerText = "Guardar";
            button.classList.replace("bg-green-500", "bg-secondary");
            button.disabled = false;
          }, 1500);
        }
      });
    });

    // --- 2. Edit Order Logic (New) ---
    const editModal = document.getElementById("editModal") as HTMLDialogElement;
    const modalContent = document.getElementById("modalContent");
    const saveEditBtn = document.getElementById("saveEditBtn");
    
    let currentEditId: string | null = null;
    let oldDetails: any[] = []; // To calculate delta

    document.querySelectorAll(".edit-order").forEach(btn => {
        btn.addEventListener("click", () => {
             const id = btn.getAttribute("data-id");
             const detallesRaw = btn.getAttribute("data-detalles");
             
             if (!id || !detallesRaw) return;

             currentEditId = id;
             oldDetails = JSON.parse(detallesRaw);
             
             // Render Items
             if (modalContent) {
                 // Map cantidad to qty just in case mixing old/new records
                 const renderItems = oldDetails.map(item => ({
                     ...item,
                     qty: item.cantidad ?? item.qty // Fallback for backward compat
                 }));

                 modalContent.innerHTML = renderItems.map((item, idx) => `
                    <div class="flex items-center justify-between gap-4 p-4 bg-gray-50 rounded-2xl border border-gray-100 item-row" data-idx="${idx}">
                        <div class="flex-1">
                            <p class="font-bold text-gray-900">${item.visualName || item.name || 'Producto'}</p>
                            <p class="text-xs text-gray-500">$${item.precio || item.price}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             <label class="text-xs font-bold uppercase text-gray-400">Cant.</label>
                             <input type="number" min="0" value="${item.qty}" class="qty-input w-20 h-10 rounded-xl border-gray-200 text-center font-bold" />
                        </div>
                    </div>
                 `).join('');
             }

             editModal.showModal();
        });
    });

    saveEditBtn?.addEventListener("click", async () => {
        if (!currentEditId || !modalContent) return;

        saveEditBtn.textContent = "Procesando...";
        (saveEditBtn as HTMLButtonElement).disabled = true;

        try {
            // 1. Capture New State
            const inputs = modalContent.querySelectorAll(".qty-input");
            const newDetails = oldDetails.map((item, idx) => {
                 const input = inputs[idx] as HTMLInputElement;
                 const newQty = parseInt(input.value) || 0;
                 return { ...item, cantidad: newQty, qty: newQty }; // Update both for consistency
            });

            // 2. Calculate Deltas & Update Stock
            const updates = newDetails.map(async (newItem, idx) => {
                const oldItem = oldDetails[idx];
                const oldQty = oldItem.cantidad ?? oldItem.qty ?? 0;
                const delta = newItem.qty - oldQty;

                if (delta !== 0) {
                     // Fetch current stock
                     const { data: prod } = await supabase.from('productos').select('stock_cantidad').eq('id', newItem.id).single();
                     if (prod) {
                         const newStock = prod.stock_cantidad - delta;
                         await supabase.from('productos').update({ stock_cantidad: newStock }).eq('id', newItem.id);
                     }
                }
            });
            
            await Promise.all(updates);

            // 3. Update Order
            // Recalculate Total
            const newTotal = newDetails.reduce((acc, item) => {
                const price = item.precio ?? item.price ?? 0;
                return acc + (item.qty * price);
            }, 0);
            
            const { error } = await supabase.from('pedidos').update({
                detalles: newDetails,
                total: newTotal
            }).eq('id', currentEditId);

            if (error) throw error;

            alert("‚úÖ Pedido actualizado y stock sincronizado.");
            window.location.reload();

        } catch (err: any) {
            console.error(err);
            alert("Error: " + err.message);
            saveEditBtn.textContent = "Guardar Cambios";
            (saveEditBtn as HTMLButtonElement).disabled = false;
        }
    });

    // --- 3. Cancel Logic (New) ---
    document.querySelectorAll(".cancel-order").forEach(btn => {
        btn.addEventListener("click", async () => {
             const id = btn.getAttribute("data-id");
             const detallesRaw = btn.getAttribute("data-detalles");
             
             if (!id || !confirm("¬øCancelar pedido? Esto restaurar√° el stock de los productos.")) return;

             const details = JSON.parse(detallesRaw || "[]");
             const button = btn as HTMLButtonElement;
             button.disabled = true;

             try {
                // Restore Stock
                const restores = details.map(async (item: any) => {
                     const qty = item.cantidad ?? item.qty ?? 0;
                     if (qty === 0) return;

                     const { data: prod } = await supabase.from('productos').select('stock_cantidad').eq('id', item.id).single();
                     if (prod) {
                         // Add back the quantity
                         await supabase.from('productos').update({ stock_cantidad: prod.stock_cantidad + qty }).eq('id', item.id);
                     }
                });

                await Promise.all(restores);

                // Update Status
                const { error } = await supabase.from('pedidos').update({ estado: 'Cancelado' }).eq('id', id);
                if (error) throw error;

                alert("Pedido cancelado y stock restaurado.");
                window.location.reload();

             } catch (e: any) {
                 alert("Error: " + e.message);
                 button.disabled = false;
             }
        });
    });

    // --- 4. Delete Logic (Renamed/Kept) ---
    document.querySelectorAll(".delete-order").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-id");
        if (confirm("‚ö†Ô∏è ¬øSolo borrar registro? Esto NO restaura stock.\n\nUsa 'Cancelar' si quieres devolver los productos al inventario.")) {
          const { error } = await supabase
            .from("pedidos")
            .delete()
            .eq("id", id);
          if (error) alert("Error al borrar");
          else window.location.reload();
        }
      });
    });
  };

  document.addEventListener("astro:page-load", initOrders);
</script>
