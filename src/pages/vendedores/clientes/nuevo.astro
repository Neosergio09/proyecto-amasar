---
import VendedorLayout from "../../../layouts/VendedorLayout.astro";
import { getSupabaseServer } from "../../../lib/supabase";

const supabase = await getSupabaseServer(Astro.cookies);
const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) {
    return Astro.redirect("/admin/login");
}
---

<VendedorLayout title="Nuevo Cliente | Amasar Go">
    <div class="min-h-screen bg-gray-50 pb-24">
        <!-- Header Sticky -->
        <header
            class="sticky top-0 z-30 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-100 px-6 py-4 rounded-b-[2rem] flex items-center justify-between"
        >
            <button
                onclick="window.history.back()"
                class="p-2 rounded-full hover:bg-gray-100 transition-colors"
            >
                <svg
                    class="w-6 h-6 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path></svg
                >
            </button>
            <h1 class="text-lg font-black text-gray-900 tracking-tight">
                Nuevo Prospecto
            </h1>
            <div class="w-10"></div>
        </header>

        <main class="p-6">
            <div
                class="bg-white rounded-[2rem] shadow-sm border border-gray-100 p-6 space-y-5"
            >
                <div
                    class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex items-start gap-3"
                >
                    <div
                        class="bg-blue-200 p-2 rounded-full text-blue-700 mt-1"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path></svg
                        >
                    </div>
                    <div>
                        <p class="text-sm font-bold text-blue-900">
                            Registro Rápido
                        </p>
                        <p class="text-xs text-blue-700 mt-1">
                            Este cliente se te asignará automáticamente.
                        </p>
                    </div>
                </div>

                <form id="newClientForm" class="space-y-4">
                    <input type="hidden" id="vendedorId" value={user.id} />

                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1"
                            >Nombre del Negocio / Cliente <span
                                class="text-red-500">*</span
                            ></label
                        >
                        <input
                            type="text"
                            id="nombre"
                            required
                            placeholder="Ej. Tienda Don Pepe"
                            class="w-full h-14 bg-gray-50 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 rounded-2xl px-5 text-base font-medium transition-all shadow-sm"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1"
                            >Nombre de Contacto</label
                        >
                        <input
                            type="text"
                            id="contacto"
                            placeholder="Ej. Juan Pérez"
                            class="w-full h-14 bg-gray-50 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 rounded-2xl px-5 text-base font-medium transition-all shadow-sm"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1"
                            >Dirección <span class="text-red-500">*</span
                            ></label
                        >
                        <input
                            type="text"
                            id="direccion"
                            required
                            placeholder="Calle 123 # 45-67"
                            class="w-full h-14 bg-gray-50 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 rounded-2xl px-5 text-base font-medium transition-all shadow-sm"
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1"
                                >Barrio <span class="text-red-500">*</span
                                ></label
                            >
                            <input
                                type="text"
                                id="barrio"
                                required
                                placeholder="El Prado"
                                class="w-full h-14 bg-gray-50 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 rounded-2xl px-5 text-base font-medium transition-all shadow-sm"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1"
                                >Teléfono <span class="text-red-500">*</span
                                ></label
                            >
                            <input
                                type="tel"
                                id="telefono"
                                required
                                placeholder="300..."
                                class="w-full h-14 bg-gray-50 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 rounded-2xl px-5 text-base font-medium transition-all shadow-sm"
                            />
                        </div>
                    </div>

                    <div class="pt-4">
                        <button
                            type="submit"
                            id="submitBtn"
                            class="w-full h-14 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-[2.5rem] shadow-xl shadow-blue-200 text-lg flex items-center justify-center gap-2 active:scale-95 transition-all"
                        >
                            <span>Guardar Cliente</span>
                            <svg
                                class="w-5 h-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M5 13l4 4L19 7"></path></svg
                            >
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>
</VendedorLayout>

<script>
    import { supabase } from "../../../lib/supabase";

    const form = document.getElementById("newClientForm");
    const submitBtn = document.getElementById("submitBtn");

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!submitBtn) return;
        const originalContent = submitBtn.innerHTML;
        submitBtn.textContent = "Guardando...";
        (submitBtn as HTMLButtonElement).disabled = true;

        const nombre = (document.getElementById("nombre") as HTMLInputElement)
            .value;
        const contacto = (
            document.getElementById("contacto") as HTMLInputElement
        ).value;
        const direccion = (
            document.getElementById("direccion") as HTMLInputElement
        ).value;
        const barrio = (document.getElementById("barrio") as HTMLInputElement)
            .value;
        const telefono = (
            document.getElementById("telefono") as HTMLInputElement
        ).value;
        const vendedorId = (
            document.getElementById("vendedorId") as HTMLInputElement
        ).value;

        // Strict Pre-flight Validation
        if (!nombre || !direccion || !barrio || !telefono) {
            alert(
                "⚠️ Todos los campos marcados con * son obligatorios:\n\n- Nombre del Negocio\n- Dirección\n- Barrio\n- Teléfono",
            );
            submitBtn.innerHTML = originalContent;
            (submitBtn as HTMLButtonElement).disabled = false;
            return;
        }

        // Geolocation Helper
        const getPosition = () => {
            return new Promise<{ lat: number | null; lng: number | null }>(
                (resolve) => {
                    if (!navigator.geolocation) {
                        resolve({ lat: null, lng: null });
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            resolve({
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude,
                            });
                        },
                        (err) => {
                            console.warn("Geolocation denied or error:", err);
                            resolve({ lat: null, lng: null });
                        },
                        { timeout: 5000 },
                    );
                },
            );
        };

        const { lat, lng } = await getPosition();

        const payload = {
            nombre_comercial: nombre,
            nombre_contacto: contacto,
            direccion: direccion,
            barrio: barrio,
            telefono: telefono,
            vendedor_id: vendedorId,
            latitud: lat,
            longitud: lng,
            created_at: new Date().toISOString(),
        };

        console.log("Sending to DB:", payload);

        const { data, error } = await supabase
            .from("clientes")
            .insert(payload)
            .select()
            .single();

        if (error) {
            alert("Error: " + error.message);
            submitBtn.innerHTML = originalContent;
            (submitBtn as HTMLButtonElement).disabled = false;
        } else {
            // Success Logic
            // Guardar como activo para pedido inmediato?
            // El usuario pidió: "redirect the seller back to the customer list"

            // Optional: Auto-select newly created customer
            if (data) {
                localStorage.setItem("active_customer", JSON.stringify(data));
            }

            alert("¡Cliente creado exitosamente!");
            window.location.href = "/vendedores/clientes";
        }
    });
</script>
