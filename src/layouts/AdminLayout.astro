---
import "../styles/global.css";
import { getSupabaseServer } from "../lib/supabase";
import { ClientRouter } from "astro:transitions";
import "@fontsource/inter";

// Auth Guard
const supabase = await getSupabaseServer(Astro.cookies);
const {
    data: { session },
} = await supabase.auth.getSession();

if (!session) {
    return Astro.redirect("/admin/login");
}
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <title>Amasar | Administración</title>
        <ClientRouter />
    </head>
    <body
        class="bg-gray-50 text-slate-800 font-sans h-screen flex overflow-hidden"
    >
        <!-- Sidebar -->
        <aside
            class="w-64 bg-white border-r border-gray-200 flex flex-col shrink-0"
        >
            <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-secondary flex items-center justify-center text-white font-bold text-xs"
                >
                    A
                </div>
                <span class="font-serif text-lg font-bold text-secondary"
                    >Admin Panel</span
                >
            </div>

            <nav class="flex-1 p-4 space-y-1">
                <a
                    href="/admin/dashboard"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 rounded-xl hover:bg-gray-50 hover:text-primary transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                        ></path>
                    </svg>
                    Escritorio
                </a>
                <a
                    href="/admin/productos"
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-primary bg-primary/5 rounded-xl transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                        ></path>
                    </svg>
                    Gestión de Productos
                </a>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <button
                    id="logoutBtn"
                    class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-red-600 hover:bg-red-50 rounded-xl transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path>
                    </svg>
                    Cerrar Sesión
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto bg-gray-50 p-8">
            <div class="max-w-6xl mx-auto">
                <slot />
            </div>
        </main>

        <script>
            import { supabase } from "../lib/supabase";

            const logoutBtn = document.getElementById("logoutBtn");
            logoutBtn?.addEventListener("click", async () => {
                await supabase.auth.signOut();
                window.location.href = "/login";
            });
        </script>
    </body>
</html>
